{"version":3,"file":"soucouyant.js","sources":["../src/accumilator.js","../src/cache.js","../src/create-address.js","../src/state-object.js","../src/collection.js"],"sourcesContent":["import cache from 'cache';\n\n/** \n Accumilates frames.\n\n**/\nconst accumilator = [\n    []\n];\nconst uniqueStateReferences = [];\n\nconst persistence = {\n    options: {\n        mergeFidelity: 0,\n    }\n};\n\n// Update settings.\nexport const persistenceSettings = options => Object.assign(persistence.options, options);\n\n\n// Adds a new state to the accumilator \n// May create a new frame to do so.\nexport const addNewState = (state, identity) => {\n    const currentTimeStamp = Date.now();\n    const mergeFidelity = persistence.options.mergeFidelity;\n    // Check unique states and add the state if does not yet exist.\n    // Directly reference the existing state.\n    const stateAsString = JSON.stringify(state);\n    const uniqueStateReferencesLength = uniqueStateReferences.length;\n\n    let stateExist = false;\n    let directReference;\n    for (let i = 0; i < uniqueStateReferencesLength; i++) {\n        const uniqueState = uniqueStateReferences[i];\n        const hasExistingState = JSON\n            .stringify(uniqueState) === stateAsString;\n        if (hasExistingState) {\n            directReference = uniqueState;\n            stateExist = true;\n            break;\n        }\n    }\n\n    if (stateExist === false) {\n        uniqueStateReferences.push(state);\n        directReference = uniqueStateReferences[uniqueStateReferences.length - 1];\n    }\n\n    // Find frame by timestamp\n    const accumilatorLength = accumilator.length;\n    const lastFrame = accumilator[accumilatorLength - 1];\n    const lastFrameTimeStamp = lastFrame[0];\n\n    // If within proximity merge. \n    const withinMergePeriod = lastFrameTimeStamp + mergeFidelity > currentTimeStamp;\n    if (withinMergePeriod) {\n        // merge to last frame\n        lastFrame.push([identity, directReference]);\n    } else {\n        // Add new frame.\n        accumilator.push([\n            currentTimeStamp, [\n                identity,\n                directReference\n            ]\n        ]);\n    }\n\n\n    const subscriptons = cache.subscriptons;\n    // Execute subscriptons\n    if (subscriptons[identity] === undefined) {\n        subscriptons[identity] = {};\n    }\n    const subIdentity = subscriptons[identity];\n    const subIdentityLength = Object.keys(subIdentity).length;\n\n    for(let ref in subIdentity){\n        subIdentity[ref](directReference, identity, currentTimeStamp);\n    }\n\n    // console.log('accumilator', JSON.stringify(accumilator, null, '\\t'));\n}\n\nexport const getCurrentState = (identity) => {\n    const accumilatorLength = accumilator.length;\n    for (let i = accumilatorLength; i > -1; --i) {\n        const frame = accumilator[i] || [];\n        const frameLength = frame.length;\n        for (let j = 0; j < frameLength; j++) {\n            if (frame[j][0] === identity) {\n                return frame[j][1];\n            }\n        }\n    }\n}","export default {\n\tsubscriptions: {}\n}","import StateObject from './state-object';\nimport { addNewState, getCurrentState } from './accumilator';\nimport cache from './cache';\n\nconst stateMachine = (state, identity) => {\n    const stateModifier = callback => {\n        const lastState = state === null ? getCurrentState(identity) : state;\n        const newState = callback(lastState);\n        addNewState(newState, identity);\n        if (state !== null) {\n            state = null;\n        }\n        return newState;\n    }\n\n    stateModifier.subscribe = (ref, callback) => {\n        if (cache.subscriptions[identity] === undefined) {\n            cache.subscriptions[identity] = {};\n        }\n\n        if (cache.subscriptions[identity][ref] === undefined) {\n            cache.subscriptions[identity][ref] = callback;\n        } else {\n            console.error(`The subscriptioin reference ${ref} is already in use for identity ${identity}`);\n        }\n    }\n\n    return stateModifier;\n}\n\nlet identity = -1;\nconst createAddress = (addressParts, count, state, length, isCollection, nextPart) => {\n    if (nextPart === null) {\n        const newPart = (addressParts[count] + '').trim();\n        if (StateObject[newPart] === undefined) {\n            nextPart = StateObject[newPart] = {};\n        } else {\n            nextPart = StateObject[newPart];\n        }\n    } else {\n        const isEndOfPath = count === length - 1;\n        const newPart = (addressParts[count] + '').trim();\n        if (nextPart[newPart] === undefined) {\n            identity++;\n            const machine = isEndOfPath ? isCollection ? state : stateMachine(state, identity) : {};\n            nextPart = nextPart[newPart] = machine;\n            if (isEndOfPath) {\n                return;\n            }\n        } else {\n            nextPart = nextPart[newPart];\n            if (isEndOfPath) {\n                return;\n            }\n        }\n\n    }\n    count++;\n    createAddress(addressParts, count, state, length, isCollection, nextPart);\n}\n\nexport default createAddress;","import createAddress from './create-address';\n\nexport default function StateObject(address, state) {\n    const addressParts = address[0].split('>');\n    const addressPartsLength = addressParts.length;\n\n    createAddress(\n        addressParts,\n        0,\n        state,\n        addressPartsLength,\n        false,\n        null\n    );\n    return StateObject\n}","import StateObject from './state-object';\nimport createAddress from './create-address';\nimport { addNewState, getCurrentState } from './accumilator';\n\nconst checkType = type => {\n    switch (type) {\n        case Array:\n            return [];\n        case Object:\n            return '';\n        default:\n            return type;\n            // if (Array.isArray()) {\n            //     return type;\n            // }\n    }\n}\n\nlet identity  = -1;\nexport default (type, hasEntries = false) => {\n identity++;\n    // Get the corresponding dataset according to the type.\n    const dataset = checkType(type);\n    const isArray = Array.isArray(dataset);\n    const isObject = isArray ? false : ((dataset) + '').indexOf('Object') >= 0;\n\n    // Check if the array has entries.\n    const data = isArray && hasEntries ? type : dataset.map((item, i) => [i, item]);\n\n    // A Deletable clone. \n    let initalDataClone = Array.from(data);\n\n    // Inital update\n    addNewState(data, identity);\n\n    const properties = {\n        data,\n        initialData: initalDataClone, // Clone inital data.\n        get entries() {\n            return getCurrentState(identity);\n        },\n        get states() {\n            return this.data.map(entry => entry[1]);\n        },\n        get ids() {\n            return this.data.map(entry => entry[0]);\n        },\n        update(newEntries) {\n            addNewState(newEntries, identity);\n        },\n        get firstId() {\n            return this.data[0][0];\n        },\n        get lastId() {\n            const length = this.data.length;\n            return this.data[length - 1][0];\n        },\n        get nextId() {\n            const length = this.data.length;\n            return this.data[length - 1][0];\n        },\n        get lastIndex() {\n            return this.data.length - 1;\n        },\n        get nextIndex() {\n            return this.data.length;\n        },\n        get firstState() {\n            return this.data[0][1];\n        },\n        get lastState() {\n            const length = this.data.length - 1;\n            console.log(length)\n            return this.data[length][1];\n        },\n        get firstEntry() {\n            return this.data[0];\n        },\n        get lastEntry() {\n            const length = this.data.length;\n            return this.data[length - 1];\n        },\n        get length() {\n            return this.data.length;\n        },\n    }\n    // return properties;\n    return (address) => {\n\n        const addressParts = address[0].split('>');\n        const addressPartsLength = addressParts.length;\n\n        createAddress(\n            addressParts,\n            0,\n            properties,\n            addressPartsLength,\n            true,\n            null\n        );\n    }\n}\n\n\n\n// get lastRemovedIds(){\n// \treturn \n// }\n// get initalLength() {\n//     return initalDataClone.length;\n// }\n// get initalEntries() {\n//     return initalDataClone;\n// }\n// get initalIds() {\n//     return initalDataClone.map(entry => entry[0]);\n// }\n// get initalStates() {\n//     return initalDataClone.map(entry => entry[0]);\n// }"],"names":["accumilator","uniqueStateReferences","persistence","addNewState","state","identity","currentTimeStamp","Date","now","mergeFidelity","options","stateAsString","JSON","stringify","uniqueStateReferencesLength","length","stateExist","directReference","i","uniqueState","hasExistingState","push","accumilatorLength","lastFrame","lastFrameTimeStamp","withinMergePeriod","subscriptons","cache","undefined","subIdentity","subIdentityLength","Object","keys","ref","getCurrentState","frame","frameLength","j","stateMachine","stateModifier","callback","lastState","newState","subscribe","subscriptions","error","createAddress","addressParts","count","isCollection","nextPart","newPart","trim","StateObject","isEndOfPath","machine","address","split","addressPartsLength","checkType","type","Array","hasEntries","dataset","isArray","isObject","indexOf","data","map","item","initalDataClone","from","properties","entries","states","entry","ids","newEntries","firstId","lastId","nextId","lastIndex","nextIndex","firstState","log","firstEntry","lastEntry"],"mappings":"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"}